name: GitHub Actions

on:
  push:
    branches:
      - master
  pull_request:

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Setup Python ğŸ
        id: setup-python
        uses: actions/setup-python@v3
        with:
          python-version: "3.10.4"

      - name: Install Poetry ğŸ“¦
        uses: snok/install-poetry@v1.3.1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache virtual environment ğŸ’¾
        uses: actions/cache@v3
        with:
          path: .venv
          key: ${{ runner.os }}-venv-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-venv-${{ steps.setup-python.outputs.python-version }}-

      - name: Install dependencies âš™ï¸
        run: poetry install --no-interaction

      - name: Run Tests ğŸ§ª
        run: |
          source .venv/bin/activate
          pybabel compile -D pdf_bot -d locale
          pytest --cov=pdf_bot --cov-report=xml

      - name: Upload coverage report ğŸ“¡
        uses: codecov/codecov-action@v3.1.0
        with:
          files: ./coverage.xml

  test-image:
    name: Test Image
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Test image ğŸ§ª
        run: docker build .

  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Setup Python ğŸ
        id: setup-python
        uses: actions/setup-python@v3
        with:
          python-version: "3.10.4"

      - name: Install Poetry ğŸ“¦
        uses: snok/install-poetry@v1.3.1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache virtual environment ğŸ’¾
        uses: actions/cache@v3
        with:
          path: .venv
          key: ${{ runner.os }}-venv-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-venv-${{ steps.setup-python.outputs.python-version }}-

      - name: Install dependencies âš™ï¸
        run: poetry install --no-interaction --no-root

      - name: Run linting ğŸ§ª
        run: |
          source .venv/bin/activate
          black --check --diff main.py pdf_bot
          isort --check --diff main.py pdf_bot
          pylint main.py pdf_bot

  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [test-image, lint]
    if: ${{ github.ref == 'refs/heads/master' }}
    concurrency: production
    environment:
      name: Production
    env:
      DOCKER_IMAGE: registry.digitalocean.com/${{ secrets.DIGITALOCEAN_REGISTRY }}/${{ secrets.DIGITALOCEAN_APP_NAME }}:${{ github.sha }}

    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Install doctl ğŸŒŠ
        uses: digitalocean/action-doctl@v2.1.1
        with:
          token: ${{ secrets.DIGITALOCEAN_TOKEN }}

      - name: Authenticate to DigitalOcean ğŸ”
        run: doctl registry login --expiry-seconds 600

      - name: Build and push image ğŸ—
        run: |-
          docker build -t ${{ env.DOCKER_IMAGE }} .
          docker push ${{ env.DOCKER_IMAGE }}

      - name: Deploy ğŸš€
        uses: digitalocean/app_action@v1.1.2
        with:
          app_name: ${{ secrets.DIGITALOCEAN_APP_NAME }}
          token: ${{ secrets.DIGITALOCEAN_TOKEN }}
          images: '[
            {
            "name": "${{ secrets.DIGITALOCEAN_APP_NAME }}",
            "image": {
            "registry_type": "DOCR",
            "repository": "${{ secrets.DIGITALOCEAN_APP_NAME }}",
            "tag": "${{ github.sha }}"
            }
            }
            ]'
